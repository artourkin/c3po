@(collections: List[String], element: com.petpet.c3po.api.model.Element)

@scripts = {
    <script type="text/javascript" href="/assets/javascripts/header.js"></script>







    <script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-3.3.0.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout.mapping/2.4.1/knockout.mapping.min.js" type="text/javascript"></script>


    <script>

            function createRule(property, value, source) {
                $("#overlay").addClass('activeoverlay');
                var popup = $('#filterpopup');
                popup.css({'display': 'block', 'z-index': 11});
                var popupconfig = popup.children('.popupconfig');

                popup.children('.popupreason').html('Do you want to create a new conflict resolution rule?');
                var ruleName = $('<input type="text" id="ruleName" value="Type in the rule name">').appendTo(popupconfig);
                var table = $('<table id="ruleTable" class="display" width="80%"></table>').appendTo(popupconfig);
                var dropDown = $('<select id="dropDown"></select>').appendTo(popupconfig);
                var addButton = $('<a name="addCondition" class="grey_button" href="javascript:void(0);">Add condition</a>').appendTo(popupconfig);
                var deleteButton = $('<a name="deleteCondition" class="grey_button" href="javascript:void(0);">Delete selected condition</a>').appendTo(popupconfig);
                var submitButton = $('<a class="green_button" href="javascript:void(0);">Create rule</a>').appendTo(popupconfig);

                var elem = "";
                var objectID = window.location.href.split('/').pop();
                $.ajax({
                    type: 'GET',
                    url: '/c3po/object/' + objectID,
                    async: false,
                    success: function (oData) {
                        elem = oData;
                    }
                });

                var conditions = [];
                for (var i in elem.metadata) {
                    var p = elem.metadata[i].property.key;
                    var v = elem.metadata[i].value;
                    if (v != null)
                        conditions.push({"property": p, "value": v});
                    else if (elem.metadata[i].status == "CONFLICT") {
                        v = "CONFLICT";
                        conditions.push({"property": p, "value": v});
                    }
                }

                dropDown.append(new Option("Select a new condition to add"));
                for (var i in conditions) {
                    dropDown.append(new Option(conditions[i].property + " : " + conditions[i].value));
                }

                var filter = [];
                $.ajax({
                    type: 'GET',
                    url: '/c3po/filters',
                    async: false,
                    success: function (oData) {
                        filter = oData;
                    }
                });


                var dataRule = [];
                for (var i in filter) {
                    var row = [];
                    row.push(filter[i].property);
                    row.push(filter[i].selected);
                    row.push("condition");
                    dataRule.push(row);
                }
                var actionRow = [property, value, "action"];
                dataRule.push(actionRow);


                var table = table.DataTable({
                    paging: false,
                    searching: false,
                    info: false,
                    data: dataRule,
                    columns: [
                        {title: "Property"},
                        {title: "Value"},
                        {title: "Component"}
                    ]
                });


                table.on('click', 'tr', function () {
                    if ($(this).hasClass('selected')) {
                        $(this).removeClass('selected');
                    }
                    else {
                        table.$('tr.selected').removeClass('selected');
                        $(this).addClass('selected');
                    }
                });

                deleteButton.on('click', function () {
                    var rows = table.rows('.selected').data();
                    if (rows) {
                        var row = rows[0];
                        if (row[2] && row[2] == "condition")
                            table.row('.selected').remove().draw(false);
                    }
                });

                addButton.on('click', function () {
                    var i = document.getElementById("dropDown").selectedIndex;
                    if (i != null) {
                        var p = conditions[i - 1].property;
                        var v = conditions[i - 1].value;
                        if (p != null && v != null)
                            table.row.add([p, v, "condition"]).draw(true);
                    }
                });

                submitButton.on('click', function () {

                    var payLoad = [];
                    table.rows().every(function () {
                        var d = this.data();
                        payLoad.push(d);
                    });
                    payLoad.push([ruleName.val(), ruleName.val(), "name"]);

                    $.ajax({
                        type: 'POST',
                        url: '/c3po/conflicts',
                        dataType: 'json',
                        data: JSON.stringify(payLoad),
                        contentType: "application/json; charset=utf-8",
                        async: false,
                        success: function (oData) {
                            hideValueOptionDialog(false);
                        },
                        error: function (oData) {
                            $('.popupreason').fadeOut('fast', function () {
                                $(this).css({'color': 'red'}).html('An error occurred while sending the email! Error message is: <br />' + oData.responseText).fadeIn('slow');
                            })
                        }
                    });


                });

            }


            $('document').ready(function () {

                var elem = "";
                var objectID = window.location.href.split('/').pop();
                $.ajax({
                    type: 'GET',
                    url: '/c3po/object/' + objectID,
                    async: false,
                    success: function (oData) {
                        elem = oData;
                    }
                });


                var data = elem;
                var result_array;

                var ViewModel = function () {
                    var self = this;
                    self.Name = ko.observable('Marat');
                    self.MyData = ko.observableArray();
                    self.people = ko.observableArray([
                        {name: 'Bert'},
                        {name: 'Charles'},
                        {name: 'Denise'}
                    ]);
                    self.checkboxClick = function (myData, value) {
                        //self.MyData.remove(myData);
                        console.log(myData);
                        var index=self.SelectedData.indexOf(myData);
                        if (index>-1)
                        {
                            self.SelectedData.splice(index,1);
                            console.log("removed the property:" + myData);
                        } else{
                            self.SelectedData.push(myData);
                            console.log("added new property:" + myData);
                        }
                        return true;
                    }
                    self.SelectedData = ko.observableArray();
                    self.ColumNames = ko.observableArray();
                    result_array=self.SelectedData;
                };
                var viewModel = new ViewModel();

                var UI = (function () {
                    var module = {};
                    return module;
                })();

                var CONTROLLER = (function () {
                    var module = {};

                    return module;
                })();

                var MAPPING = (function () {
                    var module = {};
                    module.ToMyData = function (input) {
                        var mapping = {
                            //customize at the root level.
                            create: function (options) {
                                //first map the vm like normal
                                //var vm = ko.mapping.fromJS(options.data, { observe: ["login"] });
                                var vm = options.data;
                                //now manipulate the returned vm in any way that you like
                                vm.checked = ko.observable(false);

                                //return our vm that has been mapped and tweaked
                                return vm;
                            }
                        };
                        ko.mapping.fromJS(input, mapping, viewModel.MyData);

                    };
                    module.ToColumNames = function (names) {
                        var p = names[0];
                        for (var key in p) {
                            if (p.hasOwnProperty(key)) {
                                viewModel.ColumNames.push(key);
                            }
                        }

                    };

                    return module;
                })();

                ko.applyBindings(viewModel);
                window.onload = function () {
                    MAPPING.ToColumNames(data);
                    MAPPING.ToMyData(data);
                }


                var RefreshViewModel = function () {
                    //viewModel = new ViewModel();
                    MAPPING.ToMyData(data);
                    //ko.applyBindings(viewModel);
                }


                var createRuleButton = $('<a name="ruleCreate" class="grey_button" href="javascript:void(0);">Create a rule</a>').appendTo('#table');

                createRuleButton.on('click', function () {
                    var inputs = document.getElementsByClassName("my-checked-property-value");
                    var valuesToDelete=[];
                    for (var i in inputs){
                        if (inputs[i].checked) {
                            var tmp=new Object();
                            tmp.source = inputs[i].getAttribute('data_source');
                            tmp.property = inputs[i].getAttribute('data_property');
                            tmp.value = inputs[i].getAttribute('value');

                            valuesToDelete.push(tmp);
                        }
                    }
                    var conditions=viewModel.SelectedData();


                    var uid=document.getElementById('uid').innerHTML;
                    var result={"conditions": conditions, "valuesToDelete": valuesToDelete, "uid": uid};
                    $.ajax({
                        type: 'POST',
                        url: '/c3po/conflicts',
                        dataType: 'json',
                        data: JSON.stringify(result),
                        contentType: "application/json; charset=utf-8",
                        async: false,
                        success: function (oData) {
                            $(this).css({'color': 'black'}).html('A new rule was created').fadeIn('slow');
                        },
                        error: function (oData) {
                            $('.popupreason').fadeOut('fast', function () {
                                $(this).css({'color': 'red'}).html('An error occurred while sending the email! Error message is: <br />' + oData.responseText).fadeIn('slow');
                            })
                        }
                    });
                });

            })

    </script>

}

@main("c3po", collections, scripts) {
    @if(element != null) {
        <div id="objects" class="content">
            <h2>@element.getName()</h2>
            <div class="element_general">
                <p>
                    UID: <div id="uid">@element.getUid()</div><br />
                    Collection: @element.getCollection()
                </p>
            </div>

            <style>
            table { width: 500px; }
            .grow { width: 100%; }​

            </style>
            <div id="table" >
                <table border="1" width="500px" >
                    <tr>
                        <th>check</th>
                            <!--ko foreach: ColumNames-->
                        <th data-bind="text: $data"></th>
                            <!--/ko-->
                    </tr>
                        <!--ko foreach: MyData-->
                    <tr>
                        <td  width="5">
                            <div><input data-bind="click: $root.checkboxClick" type="checkbox"/></div>
                        </td>
                            <!--ko foreach: {data: $root.ColumNames, as: 'columnName'}-->
                        <td width="5">
                                <!-- ko if: $parent[columnName] &&  columnName!='property' -->
                            <input class="my-checked-property-value" data-bind="attr: {  data_source: columnName, data_property:$parent['property']  }, value: $parent[columnName] " type="checkbox" />
                                <!-- /ko -->
                            <span data-bind="text:$parent[columnName]"></span>
                        </td>
                            <!--/ko-->
                    </tr>
                        <!--/ko-->
                </table>
            </div>


        </div>


    }
}

