\documentclass[a4paper,12pt]{article}
%\documentclass[a4paper,10pt]{scrartcl}

\usepackage[utf8]{inputenc}


\usepackage{geometry}
\usepackage{graphicx}
\geometry{verbose,tmargin=3cm,bmargin=3cm,lmargin=2cm,rmargin=2cm}
\usepackage[hyphens]{url}
\usepackage[colorlinks,
pdfpagelabels,
pdfstartview = FitH,
bookmarksopen = true,
bookmarksnumbered = true,
linkcolor = blue,
plainpages = false,
hypertexnames = false,
citecolor = black] {hyperref}

\usepackage{multirow}

\usepackage{fancyhdr}

\usepackage{listings}
\usepackage{tabularx}

\pagestyle{fancy}

\lhead{Conflict Reduction by Rulebased Postprocessing in C3PO}
%\chead{}
\rhead{}

\lfoot{Lukas Rötzer, Peter Schmidt}
\cfoot{}
\rfoot{\thepage}

\title{Conflict Reduction by Rulebased Postprocessing in C3PO\\ \medskip Report}
\author{Lukas Rötzer, Peter Schmidt}
\date{05.06.2013}

\pdfinfo{%
  /Title    (Conflict Reduction by Rulebased Postprocessing in C3PO)
  /Author   (Lukas Rötzer, Peter Schmidt)
  /Creator  (Lukas Rötzer, Peter Schmidt)
  /Producer ()
  /Subject  ()
  /Keywords (C3PO, digital preservation, preservation planning, profiling, post processing)
}

\begin{document}

\maketitle
\thispagestyle{empty}

\clearpage



\section{Introduction}

The goal was to develop and apply post-processing methods and tools to \emph{FITS}\footnote{\url{https://code.google.com/p/fits/}} characterisation files within \emph{C3PO}\footnote{\url{http://ifs.tuwien.ac.at/imp/c3po}} to reduce the problem of "conflicting values" and significantly improve data quality. 

The problem of conflicting values arises from the fact, that \emph{FITS} uses several independent tools to gather information about the inspected files. This is necessary, because different tools retrieve information of different quality on the vast amount of file types and formats. The downside of this is the fact, that the tools sometimes don't agree on the value of metadata properties. Reasons for this disagreement are various and range from different wording (``Portable Document Format'' vs. ``PDF EXIM'') to different format version recognition, or an insufficient mime-type specification (``text/plain'' vs. ``text/rtf''). 

While some of these conflicts are detected correctly and correspond to corrupted or incorrect data in the inspected file, a bigger portion of them could be avoided, if the specific weaknesses of the used tools were known to \emph{C3PO}. To provide this ability, rules need to be defined by human experts, that know about the abilities and flaws of the tools. They then need to be applied automatically while parsing the data provided by \emph{FITS}. 

\emph{C3PO} already provided a way to apply and execute post-processing rules. They are applied either while parsing single properties (pre-processing) or after all information is available (post-processing). We used and adapted these built in mechanisms to apply our conflict resolution framework. The rules can be exchanged and adapted and every user of \emph{C3PO} has the possibility to add his own specific set or remove other rules according to the circumstances of his configuration.

Digital preservation depends strongly on data integrity and authenticity. Traceability of any action taken throughout the whole process is needed not only for testing and quality assurance, but also for provability and justification. To achieve this, we keep track of all rules and changes that were applied to the metadata during conflict resolution. This gives human experts the possibility to evaluate the set of rules used and to redefine them iteratively.


\section{Workflow}
When profiling a file set, the single files need to be analysed using \emph{FITS}, that generates an XML report for every single file. These reports are parsed by \emph{C3PO} by calling its command line interface with the \emph{-g} option to gather information. Upon initialization, the current configuration is loaded and several threads are spawned to parse the input data in parallel. Every thread uses an adaptor to handle the input data, according to its origin.

The \emph{FITS} adaptor uses an Apache Commons Digester to parse the XML files. Therefore certain rules \footnote{\url{http://commons.apache.org/proper/commons-digester/guide/core.html\#doc.Rules}} are defined that are triggered on the occurrence of specific XML tags to copy the data into generated Java objects. To keep track of the objects during traversal of the file, the Digester uses an object stack. The adaptor pushes a \emph{DigesterContext} object onto that stack that holds all collected data.

To parse the data, \emph{C3PO} implements processing rules, that can be either applied to the data of single XML tags while reading the data (pre-processing). Afterwards, when the DigesterContext is completely built from the XML file, the post-processing methods are executed, where:
\begin{itemize}
\item the metadata properties are set
\item the collection name of the database is set
\item if desired, date values can be obtained from the element name
\item at last, the post-processing rules are called
\end{itemize}
Finally, the generated object is persisted in the database and the next XML file is fetched form the input.

\section{Implementation}

Since there exist a great variety of rule frameworks already, we evaluated these and choose to use the \emph{Drools Framework}\footnote{\url{http://www.jboss.org/drools/}} instead, because it's well documented and has a large community.
Drools is a rule engine, based on the \emph{Rete algorithm} and tailored for the Java language. Rete was adopted to an object-oriented interface, which allows for more natural expressions of business rules.

We added a new PostProcessingRule called \emph{DroolsConflictResolutionProcessingRule} to the Workflow, which parses the rule definitions and applies them to the current object.

\subsection{Rule Framework}

\subsubsection{Basic Rules Structure}

A rule consists of of the following parts, but can basically seen as IF-THEN function:
\begin{itemize}
\item \emph{name}: identifies a rule
\item \emph{salience}: ranges from 0 to 1000, where 1000 is the maximum priority
\item \emph{when}: defines, when a rule is triggered
\item \emph{then}: defines, what to do, when the rule is triggered
\end{itemize}



\newpage
\lstset{xleftmargin=\parindent,basicstyle=\footnotesize\ttfamily,morecomment=[l]{//} }
\begin{lstlisting}

rule "set format GZIP to GZIP Format from Exiftool"
        salience 160
    when 
        $e : Element()
        $md : MetadataRecord(
            property.id == "format", 
            value == "GZIP",
            util.isFromTool(this, "Exiftool")
        ) from $e.metadata

    then
        String newValue = "GZIP Format";
        $md.setValue(newValue);
        modify ($e) {
            getId()
        }
end

\end{lstlisting}

In the context of conflict resolution, a property is not just a key-value pair, but actually a triple consisting of its name, value and defining source (the tool name and its version). The operations support access to these pieces of information, testing for their existence, their values and their relation. Numerical expressions need not only to be tested for equality, but also for their relation. This allows defining rules for certain versions of a tool, not by listing all known versions, but declaring a minimum or maximum version, that this rule applies to. For string values an operator to compare it for occurrence within a list of given strings (e.g. \emph{fileformat IN (``XHTML'', ``XML'')}) will ease the definition of rules and improve readability.

All operators evaluate to boolean values that can be combined with logical expressions like NOT, AND, OR.

If a rules condition eventually evaluates to true, an action needs to be performed. Possible actions are the removal of one or multiple properties, that match a certain criteria (originating from a specific tool or not having a specific value), removing all but one conflicting values or changing of a value in case of naming conflicts (see below). 

\subsubsection{Strategies}

There exist several different strategies on how a conflict can be resovled. This mainly depends on the type of conflict, e.g. is it just a naming conflict or does one or several tools report a false value.

\begin{itemize}
\item \textbf{Merge}: When several tools agree on a value of a metadata element, but just have different string representation, the values can be merged. For example, Exiftool reports ``XLS`` and all other tools report ``Microsoft Excel Format``, then the value is set to ``Microsoft Excel Format``
\item \textbf{Ignore}: When it's known, that a tool sometimes reports false values on a specific metadata element, but other tools typically generate the correct value, then these false values can just be ignored. For example, if Exiftool reports some format string, and at least to others claim it to be ``Portable Document Format``, Exiftool can be ignored.

\end{itemize}


\subsection{Logging}

To ensure the traceability of the rules, and to confirm, that no valuable knowledge is lost, each change to an element is logged:
\begin{itemize}
\item Which rules has been applied and in which order were they executed
\item Which values were changed or removed
\end{itemize}

To achieve this, we extended the datamodel of an element by adding a list of log-entries. We also implemented two listeners called ``ElementModificationListener`` and ``RuleActivationListener``. The RuleActivationListener helps keeping track of activated rules by printing the statistics to the debug output.
The ElementModificationListener instead watches elements and adds modifications to the list of log-entries, which will finally be stored in database, when the element is persisted.


\section{Analysis}

For deriving and analysing our rules, we used the 10 subsets of govdocs\footnote{\url{http://digitalcorpora.org/corp/nps/files/govdocs1/zipfiles/}}.
Since the distribution of triggered rules regarding the various conflicts is similar, we only consider the subsets zero to four in our analysis.
As can bee seen in \ref{tab:files}, from 4986 files in total, 2438 had conflicts after an initial run of C3PO. After implementing and activating our rules, 1244 files remaind in conflict, which corresponds to a decrease of nearly 49\%.

Since one file can have multiple conflicts, we also analysed the impact of our implementation and rule-set on the total number of conflicts.
After an initial run of C3PO we had 5118 conflicts. This number was reduced to 2377, which is a decrease of over 53\%.
A detailed itemization of the different rules and how much conflicts they resolved can be seen in table \ref{tab:conflicts}.

\begin{table}[ht]
\begin{center}

\begin{tabular}[h]{l||r|r|r|r|r||r}
Files &  \multicolumn{5}{c}{Datasets} \\
        & 0 & 1 & 2 & 3 & 4 & Total \\
\hline
Total & 998 & 998 & 997 & 997 & 996 & 4986\\ 
\hline
with conflicts (pre) & 477 &	492 & 485 & 482	& 502 &	2438\\ 
with conflicts (post) & 249	& 243 &	240 & 253 &	259 & 1244\\
\hline
resolved & 228 & 249 & 245 & 229 & 243 & 1194

\end{tabular}
\end{center}
\caption{Analysis of improvements in files}
\label{tab:files}
\end{table}

\begin{table}[ht]
\begin{center}
\begin{tabular}[h]{l||r|r|r|r|r||r}
conflicts / improvements &  \multicolumn{5}{c}{Datasets} \\
        & 0 & 1 & 2 & 3 & 4 & Total \\
\hline
conflicts & 1016 & 1010	& 1037 & 994 &1061 & 5118 \\
\hline
GZIP to GZIP Format & 7 & 14 & 13 & 18 & 14 & 66\\
set application/rtf mimetypes to text/rtf & 1 & 1 & 0 & 3 & 0 & 5\\
set RTF format to Rich Text Format & 1 & 1 & 0 & 3 & 0 & 5\\
ignore text/plain if more precisise text/* available & 18 & 22 & 20 & 23 & 14 & 97\\
set format XLS to Microsoft Excel Format & 57 & 57 & 54 & 55 & 58 & 281\\
ignore Droid PPT false positives & 0 & 1 & 0 & 0 & 1 & 2\\
ignore others mimetypes if Droid reports PPT & 7 & 2 & 3 & 2 & 3 & 17\\
ignore others formats if Droid reports PPT & 63 & 58 & 48 & 46 & 60 & 275\\
if Jhove and Droid report xhtml, ignore others & 1 & 5 & 6 & 4 & 7 & 23\\
ignore Jhove text/html if application/xhtml+xml & 24 & 22 & 20 & 21 & 22 & 109\\
Resolve Jhove HTML Transitional format string & 40 & 38 & 46 & 32 & 37 & 193\\
html format version (etc) to value without prefix & 92 & 86 & 110 & 78 & 78 & 444\\
set sampling frequency unit Jhove & 32 & 29 & 34 & 40 & 39 & 174\\
set sampling frequency unit NLNZ & 72 & 62 & 70 & 68 & 72 & 344\\
ignore fractional exposure time by NLNZ & 14 & 7 & 12 & 10 & 10 & 53\\
\hline
remaining conflicts & 483 &	447	& 472 &	479	& 496 &	2377

\end{tabular}
\end{center}
\caption{Analysis of improvements in conflict resolution}
\label{tab:conflicts}
\end{table}


\end{document}
